<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>PP Cup — участники</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header>
    <h1>Таблица участников</h1>
    <div id="controls">
      <button id="login">Войти через osu!</button>
      <button id="logout" style="display:none;">Выйти</button>
      <button id="participate" style="display:none;">Участвовать</button>
      <button id="unparticipate" style="display:none;">Перестать участвовать</button>
      <span id="user"></span>
    </div>
  </header>

  <div id="admin-panel" style="display:none;">
    <input id="nickname-to-delete" placeholder="Ник для удаления" />
    <button id="delete-participant">Удалить</button>
    <button id="clear-table">Очистить таблицу</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Позиция</th>
        <th>Аватар</th>
        <th>Ник</th>
        <th>PP Start</th>
        <th>PP End</th>
        <th>Очки</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadData() {
      const res = await fetch('/api/data');
      const data = await res.json();
      const tbody = document.querySelector('tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${item.Position || ''}</td>
          <td><img src="\${item.Avatar}" alt="avatar" width="40" height="40"/></td>
          <td>
            <a href="https://osu.ppy.sh/users/\${item.UserID || ''}" target="_blank" rel="noopener">
              \${item.Nickname}
            </a>
          </td>
          <td>\${item.PPstart}</td>
          <td>\${item.PPend}</td>
          <td>\${item.Points}</td>
        \`;
        tbody.appendChild(tr);
      });
    }

    async function loadUser() {
      const res = await fetch('/api/me');
      if (res.ok) {
        const user = await res.json();
        document.getElementById('user').textContent = \`Привет, \${user.username}!\`;
        document.getElementById('login').style.display = 'none';
        document.getElementById('logout').style.display = 'inline-block';

        const participantsRes = await fetch('/api/data');
        const participants = await participantsRes.json();
        const isParticipating = participants.some(p => p.Nickname === user.username);

        document.getElementById('participate').style.display = isParticipating ? 'none' : 'inline-block';
        document.getElementById('unparticipate').style.display = isParticipating ? 'inline-block' : 'none';

        // admin
        if (user.username === 'LLIaBKa') {
          document.getElementById('admin-panel').style.display = 'block';
        } else {
          document.getElementById('admin-panel').style.display = 'none';
        }
      } else {
        document.getElementById('user').textContent = '';
        document.getElementById('login').style.display = 'inline-block';
        document.getElementById('logout').style.display = 'none';
        document.getElementById('participate').style.display = 'none';
        document.getElementById('unparticipate').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'none';
      }
    }

    document.getElementById('login').onclick = () => { window.location.href = '/auth/login'; };
    document.getElementById('logout').onclick = () => { window.location.href = '/auth/logout'; };

    document.getElementById('participate').onclick = async () => {
      const res = await fetch('/api/participate', { method: 'POST' });
      const result = await res.json();
      if (res.ok) { alert('Вы в таблице!'); loadData(); loadUser(); }
      else alert(result.error || 'Ошибка');
    };

    document.getElementById('unparticipate').onclick = async () => {
      const res = await fetch('/api/unparticipate', { method: 'POST' });
      const result = await res.json();
      if (res.ok) { alert('Вы удалены из таблицы'); loadData(); loadUser(); }
      else alert(result.error || 'Ошибка');
    };

    document.getElementById('delete-participant').onclick = async () => {
      const nick = document.getElementById('nickname-to-delete').value.trim();
      if (!nick) return alert('Укажите ник');
      const res = await fetch('/api/participant/' + encodeURIComponent(nick), { method: 'DELETE' });
      const result = await res.json();
      if (res.ok) { alert('Удалено'); loadData(); }
      else alert(result.error || 'Ошибка');
    };

    document.getElementById('clear-table').onclick = async () => {
      if (!confirm('Точно очистить всю таблицу?')) return;
      const res = await fetch('/api/participants', { method: 'DELETE' });
      const result = await res.json();
      if (res.ok) { alert('Очищено'); loadData(); }
      else alert(result.error || 'Ошибка');
    };

    loadUser();
    loadData();
  </script>
</body>
</html>
