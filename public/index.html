<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Таблица участников</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      margin: 0;
      padding: 2rem;
      color: #eee;
    }
    table a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }
    table a:hover {
      color: #ff6347;
      text-decoration: underline;
    }
    h1 {
      text-align: center;
      color: #fff;
      margin-bottom: 2rem;
    }
    #controls {
      text-align: center;
      margin-bottom: 2rem;
    }
    button {
      background-color: #ffffff;
      color: #000;
      border: 1px solid #555;
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: #ddd;
      color: #000;
    }
    #user {
      font-weight: bold;
      color: #ccc;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(255,255,255,0.05);
    }
    th, td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid #333;
    }
    th {
      background-color: #2a2a2a;
      color: #fff;
      font-weight: bold;
    }
    tr:hover {
      background-color: #2c2c2c;
    }
    img {
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(255,255,255,0.1);
    }
    @media (max-width: 600px) {
      table, th, td {
        font-size: 12px;
      }
      button {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div id="admin-panel" style="display: none; text-align: center; margin-bottom: 1rem;">
    <button id="clear-table">Очистить таблицу</button>
  </div>

  <h1>Таблица участников</h1>

  <div id="controls">
    <button id="login">Войти через osu!</button>
    <button id="logout" style="display:none;">Выйти</button>
    <button id="participate" style="display:none;">Участвовать</button>
    <button id="unparticipate" style="display:none;">Перестать участвовать</button>
    <div id="user"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Позиция</th>
        <th>Аватар</th>
        <th>Ник</th>
        <th>PP Start</th>
        <th>PP End</th>
        <th>Очки</th>
        <th id="admin-column" style="display:none;">Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let currentUser = null;

    async function fetchUser() {
      const res = await fetch('/api/me');
      if (res.ok) {
        currentUser = await res.json();
        document.getElementById('user').innerText = `Привет, ${currentUser.username}!`;
        document.getElementById('login').style.display = 'none';
        document.getElementById('logout').style.display = 'inline-block';

        const participantsRes = await fetch('/api/data');
        const participants = await participantsRes.json();
        const isParticipating = participants.some(p => p.Nickname === currentUser.username);

        if (isParticipating) {
          document.getElementById('participate').style.display = 'none';
          document.getElementById('unparticipate').style.display = 'inline-block';
        } else {
          document.getElementById('participate').style.display = 'inline-block';
          document.getElementById('unparticipate').style.display = 'none';
        }

        if (currentUser.username === 'LLIaBKa') {
          document.getElementById('admin-panel').style.display = 'block';
          document.getElementById('admin-column').style.display = 'table-cell';
        }
      } else {
        currentUser = null;
        document.getElementById('user').innerText = '';
        document.getElementById('login').style.display = 'inline-block';
        document.getElementById('logout').style.display = 'none';
        document.getElementById('participate').style.display = 'none';
        document.getElementById('unparticipate').style.display = 'none';
      }
    }

    async function loadData() {
      try {
        const res = await fetch('/api/data');
        if (!res.ok) throw new Error('Ошибка загрузки данных');
        const data = await res.json();
        const tbody = document.querySelector('tbody');
        tbody.innerHTML = '';
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.Position}</td>
            <td><img src="${item.Avatar}" alt="avatar" width="40" height="40" /></td>
            <td><a href="https://osu.ppy.sh/users/${item.UserID}" target="_blank">${item.Nickname}</a></td>
            <td>${item.PPstart}</td>
            <td>${item.PPend}</td>
            <td>${item.Points}</td>
            ${currentUser?.username === 'LLIaBKa' ? `<td><button onclick="deleteParticipant('${item.Nickname}')">Удалить</button></td>` : ''}
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
      }
    }

    async function deleteParticipant(nickname) {
      if (confirm(`Удалить ${nickname}?`)) {
        await fetch(`/api/participant/${encodeURIComponent(nickname)}`, { method: 'DELETE' });
        loadData();
      }
    }

    document.getElementById('clear-table')?.addEventListener('click', async () => {
      if (confirm('Очистить всю таблицу?')) {
        await fetch('/api/participants', { method: 'DELETE' });
        loadData();
      }
    });

    document.getElementById('login').onclick = () => window.location.href = '/auth/login';
    document.getElementById('logout').onclick = () => window.location.href = '/auth/logout';

    document.getElementById('participate').onclick = async () => {
      const res = await fetch('/api/participate', { method: 'POST' });
      const result = await res.json();
      if (res.ok) {
        alert('Вы успешно участвуете!');
        loadData();
        fetchUser();
      } else {
        alert(result.error || 'Ошибка при участии');
      }
    };

    document.getElementById('unparticipate').onclick = async () => {
      const res = await fetch('/api/unparticipate', { method: 'POST' });
      const result = await res.json();
      if (res.ok) {
        alert('Вы больше не участвуете');
        loadData();
        fetchUser();
      } else {
        alert(result.error || 'Ошибка при удалении');
      }
    };

    fetchUser().then(loadData);
  </script>
</body>
</html>
